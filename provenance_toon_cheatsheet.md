# Provenance & Toon Cheatsheet for Stencila / LivePublication

This document is a practical cheatsheet.

Assume you have:

```python
from provenance_context import ProvenanceCrate

crate = ProvenanceCrate.from_file("path/to/ro-crate-metadata.json")
```

If you’ve added the TOON helpers:

```python
toon_lineage = crate.to_toon_file_lineage("some_file.csv")
toon_site    = crate.to_toon_site_summary("nzd0003")
```

---

## A. Per-file lineage questions

### A1. “How was this file computed?”

**Question**

> How was `transect_time_series_tidally_corrected.csv` computed for site `nzd0003`?

**Code**

```python
lineages = crate.get_file_lineage("transect_time_series_tidally_corrected.csv")
# pick the one with the site you care about:
lin = next(l for l in lineages if "nzd0003" in l["site_ids"])
```

**Look at**

- `lin["file"]`→ which file we’re talking about (id, name, sha1).
- `lin["site_ids"]`→ site id(s) (e.g. `["nzd0003"]`).
- `lin["produced_by"]["action"]`→ step run name + times.
- `lin["produced_by"]["tool"]`→ CWL tool/subworkflow.
- `lin["produced_by"]["inputs"]`:
  - `["files"]` → input files (e.g. `transects_extended.geojson`).
  - `["datasets"]` → site directory dataset (e.g. `"nzd0003"`).
  - `["parameters"]` → parameters (e.g. `site_id`).

**TOON block**

```python
toon_block = crate.to_toon_file_lineage(
    "transect_time_series_tidally_corrected.csv"
)
```

**Stencila idea**

Attach `toon_block` as `provenance` / `toon_provenance` metadata on the figure/table that visualises this CSV.

---

### A2. “Which workflow step produced this file?”

**Question**

> Which step produced `nzd0003.xlsx`?

**Code**

```python
lineages = crate.get_file_lineage("nzd0003.xlsx")
lin = lineages[0]  # one per site_id usually

step_name = lin["produced_by"]["action"]["name"]
tool_name = lin["produced_by"]["tool"]["name"]
```

**Look at**

- `action["name"]` → e.g. `Run of workflow/packed.cwl#main/make_xlsx_site_3`.
- `tool["id"]` / `tool["name"]` → the CWL tool.

**TOON block**

```python
toon_block = crate.to_toon_file_lineage("nzd0003.xlsx")
```

**Stencila idea**

Use in a caption sidebar:
“_This spreadsheet was generated by the `make_xlsx_site.cwl` step, using inputs X, Y, and Z (see TOON provenance block)._”

---

### A3. “Which inputs (files + parameters) contributed to this output?”

**Question**

> Which inputs (files + parameters) went into `linear_nzd0003.json`?

**Code**

```python
lin = crate.get_file_lineage("linear_nzd0003.json")[0]
inputs = lin["produced_by"]["inputs"]

input_files = inputs["files"]
input_datasets = inputs["datasets"]
params = inputs["parameters"]
```

**Look at**

- `input_files` → e.g. site-level time series CSVs.
- `params` → method options, `site_id`, thresholds, etc.

**TOON block**

```python
toon_block = crate.to_toon_file_lineage("linear_nzd0003.json")
```

**Stencila idea**

For a “methods details” callout, embed a Toon block summarising the parameters and top-level inputs (no need to show entire ancestry).

---

## B. Upstream (ancestry) questions

### B1. “What is the full provenance of this file?”

**Question**

> What is the upstream pipeline for `transects.xlsx`?

**Code**

```python
ancestry = crate.get_file_ancestry("transects.xlsx", max_depth=5)
```

**Look at**

- `ancestry["root_files"]`→ which file(s) you started from.
- `ancestry["entities"]`→ all upstream files/datasets (id → summary).
- `ancestry["actions"]`→ all actions (id → {action, tool, inputs}).
- `ancestry["edges"]`
  → `used` / `generated` links.

**TOON block**

```python
toon_block = crate.to_toon_file_ancestry("transects.xlsx", max_depth=5)
```

**Stencila idea**

Use this for “pipeline overview” paragraphs. For example:

> “Given this TOON ancestry, describe in plain language the stages leading to `transects.xlsx`.”

---

### B2. “Which raw inputs ultimately feed into this file?”

**Question**

> Which original GeoJSONs and time series feed into `transect_time_series_tidally_corrected.csv`?

**Code**

```python
ancestry = crate.get_file_ancestry(
    "transect_time_series_tidally_corrected.csv",
    max_depth=None
)

entities = ancestry["entities"].values()
raw_geojsons = [e for e in entities if e["name"] and e["name"].endswith(".geojson")]
raw_csvs     = [e for e in entities if e["name"] and e["name"].endswith(".csv")]
```

**TOON block**

Same as above: use `to_toon_file_ancestry(...)` and let the LLM classify which inputs are “raw”.

**Stencila idea**

Feed the ancestry Toon to an LLM and ask it to extract and group raw inputs for a “Data sources” section.

---

## C. Forward (impact) questions

### C1. “If this input changes, which outputs are affected?”

**Question**

> If `transects_extended.geojson` is updated, which downstream outputs need to be regenerated?

**Code**

```python
desc = crate.get_file_descendants(
    "transects_extended.geojson",
    max_depth=5
)
affected_files = {f["name"] for f in desc["descendant_files"]}
```

**Look at**

- `desc["descendant_files"]` → all downstream files (excluding the root).
- `desc["actions"]` → which actions use/generate those files.

**TOON block**

```python
toon_block = crate.to_toon_file_descendants(
    "transects_extended.geojson",
    max_depth=5
)
```

**Stencila idea**

Good for explaining liveness / update behaviour:

> “If new transects are added or existing lines change, the following artefacts will be recomputed (see TOON block for details).”

---

### C2. “Which outputs depend on a specific site-level input?”

**Question**

> Starting from `nzd0003/L9/ms/..._ms.tif`, which final site outputs depend on this imagery?

**Code**

```python
desc = crate.get_file_descendants("nzd0003/L9/ms", max_depth=5)
site_outputs = [
    f for f in desc["descendant_files"]
    if "nzd0003" in (f["name"] or "")
]
```

**TOON block**

```python
toon_block = crate.to_toon_file_descendants("nzd0003/L9/ms", max_depth=5)
```

**Stencila idea**

Useful for explaining imagery provenance in map figures or per-site panels.

---

## D. Site-level questions

All via `get_site_artifacts` / `to_toon_site_summary`.

### D1. “What artefacts exist for this site?”

**Question**

> For `nzd0003`, which key outputs and intermediate files are recorded?

**Code**

```python
site = crate.get_site_artifacts("nzd0003")

files      = site["files"]       # all files mentioning nzd0003
datasets   = site["datasets"]    # all datasets mentioning nzd0003
key_names  = list(site["key_lineages"].keys())
```

Typical `key_lineages` keys include:

- `transect_time_series.csv`
- `transect_time_series_tidally_corrected.csv`
- `tides.csv`
- `nzd0003.xlsx`
- `linear_nzd0003.json`

**TOON block**

```python
toon_block = crate.to_toon_site_summary(
    "nzd0003",
    include_all_files=False
)
```

**Stencila idea**

Great for a **per-site panel**: show a chart + short narrative, backed by a site TOON block as hidden metadata or collapsible “Details”.

---

### D2. “Summarise the processing pipeline for this site”

**Question**

> How was the data for site `nzd0003` processed from raw transects to final Excel & JSON outputs?

**Code**

```python
site = crate.get_site_artifacts("nzd0003")
key_lineages = site["key_lineages"]  # dict basename -> LineageSummary
```

**TOON block**

```python
toon_block = crate.to_toon_site_summary(
    "nzd0003",
    include_all_files=False
)
```

**Stencila idea**

Prompt pattern:

> “Using this TOON `SiteSummary`, describe in 3–4 sentences how the `nzd0003` data were processed, referencing the key artefacts and main steps.”

---

### D3. “Compare processing between two sites”

**Question**

> Are the steps / parameters used for `nzd0001` and `nzd0003` the same?

**Code**

```python
site1 = crate.get_site_artifacts("nzd0001")
site3 = crate.get_site_artifacts("nzd0003")

toon1 = crate.to_toon_site_summary("nzd0001", include_all_files=False)
toon3 = crate.to_toon_site_summary("nzd0003", include_all_files=False)
```

**Stencila idea**

Provide both Toon blocks to an LLM and ask:

> “Given these two `SiteSummary` TOON blocks, highlight any differences in steps or parameters between `nzd0001` and `nzd0003`, or confirm that they are identical.”

---

## E. Parameter-centric / configuration questions

### E1. “What parameter values were used for this run / site?”

**Question**

> What `site_id` and other parameters were used when running `apply_nzd_tidal_correction` for `nzd0003`?

**Code (via file lineage)**

```python
lin = next(
    l for l in crate.get_file_lineage("transect_time_series_tidally_corrected.csv")
    if "nzd0003" in l["site_ids"]
)

params = lin["produced_by"]["inputs"]["parameters"]
```

**Stencila idea**

Use in a “configuration” or “reproducibility” callout:

> “Using this FileLineage TOON, list the parameter names and values that differ from their defaults.”

---

### E2. “Which runs used a particular parameter value?”

**Question**

> Which steps were run with `site_id == "nzd0003"`?

**Code**

```python
matches = []
for act in crate.actions:
    for obj in act.get("object", []):
        oid = obj.get("@id") if isinstance(obj, dict) else obj
        ent = crate.by_id.get(oid)
        if (
            ent and crate._has_type(ent, "PropertyValue")
            and ent.get("name") == "site_id"
            and ent.get("value") == "nzd0003"
        ):
            matches.append(act)
            break
```

(You can wrap this later as a convenience method, e.g. `get_actions_by_param(name, value)`.)

**TOON idea**

Encode `matches` into a small TOON block and ask the LLM to summarise
“all steps where `site_id = nzd0003`.”

---

## F. How to map questions to functions & Toon

When authoring the Stencila DNF, think:

> “What am I trying to justify or explain here?”

Then choose the function + Toon encoder:

| Goal / question type                       | Function(s)               | TOON encoder                           |
| ------------------------------------------ | ------------------------- | -------------------------------------- |
| Explain a specific figure/table            | `get_file_lineage`      | `to_toon_file_lineage`               |
| Show all upstream inputs for a file        | `get_file_ancestry`     | `to_toon_file_ancestry`              |
| Show all downstream outputs for an input   | `get_file_descendants`  | `to_toon_file_descendants`           |
| Tell the “story” of a site               | `get_site_artifacts`    | `to_toon_site_summary`               |
| Explain liveness / impact of changes       | `get_file_descendants`  | `to_toon_file_descendants`           |
| Compare processing between sites           | `get_site_artifacts` x2 | `to_toon_site_summary` for each site |
| Inspect parameters for a particular output | `get_file_lineage`      | `to_toon_file_lineage`               |

This should be enough to decide, for any given Stencila block:

1. **Which provenance function to call**,
2. **What data to inspect in the returned structure**, and
3. **Which Toon encoder to use** to make the LLM’s job cheaper and easier.
